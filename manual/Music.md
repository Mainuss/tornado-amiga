Music
=====

No demo would be complete without a soundtrack.  Tornado provides two ways to play music:

* Old school [Amiga modules](https://modarchive.org/index.php?article-modules) using [The Player](http://www.pouet.net/prod.php?which=64049) by Sahara Surfers.
* Lossless compressed stereo 8bit audio up to 28150Hz.

Using modules
---------------------

Modules have the advantage of potentially requiring a very small amount of memory and are best suited for intros. Capsule's 2018 [Renouncetro](http://www.pouet.net/prod.php?which=75732) 64Kib intro is such an example.

Tornado contains two copies of the P61 replay routine: One that's AmigaOS friendly and thus can be used before the demo has started, e.g. while the demo is loading, and one that uses direct hardware access and can only be used while the demo is running.

An example of how to use module music in your demo can be seen in the [Anatomy of a Demo](AnatomyOfADemo.md) section which uses the ```simple_screen``` example as a guide.

A few things to keep in mind:

* You can have as many modules as you want as long as you call ```p61Init``` and ```p61End``` for each of them.
* Modules need to reside in Chip RAM. Make sure the module data resides in Chip RAM.
* Module replay **only** works on the Amiga target. You will not hear anything when running your demo on the posix/SDL target.
* Because profiling needs the CIAB timer which is used by the module replay routine, it is not possible to have profiling and music at the same time on Amiga. Please refer to the [Performance Monitoring](PerformanceMonitoring.md) section for more information on this topic.

Using lossless compressed music
----------------------------------------------

As a composer myself, the idea of our music being butchered by the [ADPCM](https://en.wikipedia.org/wiki/Adaptive_differential_pulse-code_modulation) compression wasn't very appealing. While this algorithm results in small audio assets, it does not sound good. I always say that ADPCM-encoded music sounds nice if you've never listened to the original.

For that reason we decided to come up with a [lossless compression](https://en.wikipedia.org/wiki/Lossless_compression) system that would work well on the Amiga.

Luis "Peskanov" Pons wrote the compression tool (```flencoder``` in the tools directory) by borrowing ideas from [FLAC](https://en.wikipedia.org/wiki/FLAC) and I added replay support in Tornado.

The first thing you need is an 8bit WAV file with data saved at one of these supported sampling rates:

* 11025Hz
* 22050Hz
* 28150Hz

A 11025Hz version of the music is practical during development as it minimises loading times. For the release version of your demo we recommend that you create a 28150Hz file to obtain the highest quality. We found out that this was the most stable setting when approaching the limits of the Amiga audio hardware. [Audacity](https://www.audacityteam.org/)'s resampling algorithm produces excellent results and can be used to create these files.

You are also going to need an [MP3](https://en.wikipedia.org/wiki/MP3) or [OGG](https://xiph.org/ogg/) version of your track to be used by the posix/SDL target. This one can be the full 16bit 44100Hz version of your music as it came out of your DAW.


Let's convert a WAV file to a TNDO audio file:

```
mmendez$ flencoder < brut_final_28150.wav > brut_final_28150.tndo
TEXT: 'RIFF'
Full data size 12611236
TEXT: 'WAVE'
TEXT: 'fmt '
fmt  chunk size 16
audio_format 1
num_channels 2
sample_rate 28150
byte_rate 56300
block_align 2
bits_per_sample 8
TEXT: 'data'
data chunk size 12611200
num_samples 6305600, rounded to 6305664
Compressing signal for 8 bits
Bit encoding: average 4.5 bits
Bit encoding: average 4.6 bits

Lossless test passed, checksum 0xe27fd00

mmendez$ ls -la brut_final_28150.*
-rw-r--r--  1 mmendez  staff   7190564 17 Jun 14:30 brut_final_28150.tndo
-rw-r--r--  1 mmendez  staff  12611244 19 Apr 18:23 brut_final_28150.wav
```
 
The WAV header parser can be a bit temperamental and doesn't like files generated by certain programs. Opening the file with [Audacity](https://www.audacityteam.org/) and resaving it will take care of that.

Now let's take a look at what we did in the ```blur``` example to play music:


We have the two versions of our music in the data directory:

```
bash-5.0$ ls -al data/brut_*
-rw-r--r--  1 mmendez  staff  349968 17 May 16:20 data/brut_11025_8.tndo
-rw-r--r--  1 mmendez  staff  966447 17 May 16:15 data/brut_blur.mp3
```

We have also set the ```USE_AUDIO``` flag in our demo settings function:

```c
void demoSettings(demoParams *dp) {
  dp->minCPU = MIN_CPU_040;
  dp->tornadoOptions =
      KILL_OS | LOGGING | INSTALL_LEVEL3 | INSTALL_LEVEL2 | USE_AUDIO;
```

And this is our audio init function:

```c
// --------------------------------------------------------------------------
// Music initialisation.
// --------------------------------------------------------------------------
static int *audioSizes;
static int numAudioAssets;
static void **audioAssets;

// SDL/Posix soundtrack
#define bassTrack "data/brut_blur.mp3"

// LOW QUALITY AUDIO TRACK FOR DEVELOPMENT ONLY!!!!!
#warning "Using low quality audio track!!!"
const char *audioList[] = {"data/brut_11025_8.tndo"};

void demoAudioInit(unsigned int tornadoOptions) {
  if (tornadoOptions & USE_AUDIO) {
    numAudioAssets = sizeof(audioList) / sizeof(char *);
    audioSizes = (int *)tndo_malloc(sizeof(int) * numAudioAssets, 0);
    audioAssets = (void **)tndo_malloc(sizeof(void *) * numAudioAssets, 0);
    if (tornadoOptions & VERBOSE_DEBUGGING) {
      printf("DEBUG - Loading audio data...");
      fflush(stdout);
    }
    if (!loadAssets(&audioAssets[0], &audioList[0], &audioSizes[0],
                    numAudioAssets, tornadoOptions, my_dp)) {
      tndo_memory_shutdown(tornadoOptions);
      if (tornadoOptions & VERBOSE_DEBUGGING) {
        printf("failed!\n");
      }
      exit(1);
    }

    musicSecond = my_dp->sampleRate * (my_dp->bitsPerSample / 8);
    int offset = (effects[currentEffect].minTime / 50) * musicSecond;
    musicBeginL = *my_dp->mixState;
    musicBeginR = *my_dp->mixState2;
    *my_dp->mixState = musicBeginL + offset;
    *my_dp->mixState2 = musicBeginR + offset;

    if (tornadoOptions & VERBOSE_DEBUGGING) {
      printf("done.\n");
    }
  }

#ifndef __AMIGA__
  // Bass initialization.
  if (tornadoOptions & USE_AUDIO) {
    if (!BASS_Init(-1, 44100, 0, 0, 0)) {
      fprintf(stderr, "FATAL - Failed to init bass. Aborting.\n");
      exit(1);
    }

    stream = BASS_StreamCreateFile(0, bassTrack, 0, 0, BASS_STREAM_PRESCAN);
    if (!stream) {
      fprintf(stderr, "FATAL - Failed to open music file <%s>\n", bassTrack);
      exit(1);
    }
  }
#endif
}
```

This function is loading and uncompressing the audio data using the [Asset Manager](AssetManager.md). This happens on the posix/SDL target as well, even though this track will not be used. The reason for this is to make sure that the audio unpacking code path is working correctly.

On posix/SDL only we are also initialising the BASS library replay routine.

We call the audio init routine from the ```demoInit``` function, like this:

```c
#ifdef __AMIGA__
  timeGet(&initBegin);
  timeGet(&initEffectBegin);
#endif

  demoAudioInit(tornadoOptions);

#ifdef __AMIGA__
  timeGet(&initEffectEnd);
  initTime = timeDiffSec(&initEffectBegin, &initEffectEnd);
#endif

  if (tornadoOptions & VERBOSE_DEBUGGING) {
    printf("DEBUG - demoAudioInit() completed in %u seconds\n", initTime);
  }
```

The last thing we need to do is tell the BASS library to start playing the music on the sdl/POSIX target. This happens automagically on Amiga.

```c
// ---------------------------------------------------------------------------
// Main demo loop begins here...
// ---------------------------------------------------------------------------
void demoMain(unsigned int tornadoOptions, memoryLog *log) {

  int timings = 0;
  prof_enabled(timings);
  int loadEffect = 1;
  int mustExit = 0;
  int oldTime = 0;

  prof_reset();

#ifndef __AMIGA__
  if (tornadoOptions & USE_AUDIO) {
    BASS_Start();
    QWORD pos = BASS_ChannelSeconds2Bytes(stream, epoch / 50);
    BASS_ChannelSetPosition(stream, pos, BASS_POS_BYTE);
    BASS_ChannelPlay(stream, 0);
    if (rocket_control) {
      BASS_ChannelPause(stream);
    }
  }
#endif
```

Using modules and streaming music
------------------------------------------------

It is also possible to use both a module and streaming music in your demo. Capsule's demo [Brutalism](http://www.pouet.net/prod.php?which=81062) has 2 modules and a compressed audio stream for the main part.

In order to switch between audio modes you have to call the ```setAudioMode``` function, declared in ```audio.h```. 

The two settings are:

* ```PCM_REPLAY_MODE``` : Switch to PCM replay and initialise the Paula output routines.
* ```P61_REPLAY_MODE``` : Shut down the Paula output routines and switch to P61 replay mode.

If you were playing an audio stream and want to play a module you switch modes before calling ```p61Init```. In Brutalism, the last effect of the demo loads a p61 module during initialisation and switches to the module when the effect starts, like this:

```c
t_canvas *renderEndscroll(int frame) 
{
    _frame = frame;

    int alpha = up_down_get_alpha (_fades, frame, 2);
    if (alpha >= 0)
        display_endscroll_fade_to (0, alpha);

    if (!music_started && (frame > TIME_MUSIC_START)) 
    {
#ifdef __AMIGA__
        setAudioMode(P61_REPLAY_MODE);
        p61Init(mod_data, 0, 0, 0);
        music_started = 1;
#endif
    }
```

Similarly, to switch from a module to streaming music we would call ```p61End``` and then switch to ```PCM_REPLAY_MODE```.

